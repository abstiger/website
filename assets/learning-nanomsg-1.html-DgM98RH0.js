import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as t,a as i,b as l,d as h,e as a,o as e}from"./app-CdpNCDY8.js";const k={};function p(r,s){return e(),t("div",null,[s[0]||(s[0]=i("p",null,[i("a",{href:"http://nanomsg.org/",title:"nanomsg",target:"_blank",rel:"noopener noreferrer"},"nanomsg"),a("是"),i("a",{href:"http://zeromq.org/",title:"zeromq",target:"_blank",rel:"noopener noreferrer"},"zeromq"),a("作者Martin Sustrik用C重写的一套具有可扩展协议的一套通信框架，具体nanomsg与zeromq的不同与改进之处及为什么要用C重写在"),i("a",{href:"http://nanomsg.org/documentation-zeromq.html",title:"ifferences between nanomsg and ZeroMQ",target:"_blank",rel:"noopener noreferrer"},"这里"),a("有详细的描述，个人感觉C的代码风格和目录结构组织都看着舒服多了，：），另外Martin Sustrik博客（"),i("a",{href:"http://250bpm.com/",target:"_blank",rel:"noopener noreferrer"},"http://250bpm.com/"),a(" ）里面的每篇文章感觉都挺不错的，推荐关注订阅！")],-1)),l(" more "),s[1]||(s[1]=h(`<h2 id="框架简介" tabindex="-1"><a class="header-anchor" href="#框架简介"><span>框架简介</span></a></h2><p>因为nanomsg还处于开发测试阶段，代码量还不是十分庞大，文档和注释也不够全面，于是想通过这一系列博客，一方面记录下我对nanomsg当前源码（<a href="https://github.com/250bpm/nanomsg" target="_blank" rel="noopener noreferrer">https://github.com/250bpm/nanomsg</a>）的阅读过程，同时也学习下一个好的开源项目的代码组织及开发过程。</p><h2 id="源码组织" tabindex="-1"><a class="header-anchor" href="#源码组织"><span>源码组织</span></a></h2><p>首先看下nanomsg的src目录：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">nn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                 // nanomsg对外暴露的接口api</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">transport</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // 通信层定义，，目的应该是想暴露给用户以实现可扩展，但目前还包含utils下头文件……</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">inproc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">             // 一种transport，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">ipc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // 一种transport，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">tcp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // 一种transport，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">protocol</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // 协议层定义，目的应该是想暴露给用户以实现可扩展，但目前还包含utils下头文件……</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">reqrep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">             // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pubsub</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">             // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">bus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pair</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">               // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">survey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">             // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">utils</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                // 实用工具包，包含基本数据结构（list，queue，hash）互斥及原子操作（mutex，atomic）等</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">transports</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // 通信层实现，包括（inproc:进程内通信；ipc:进程间通信；tcp：tcp通信）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">protocols</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 协议层实现，包括（REQ/REP:请求/应答；PUB/SUB:发布订阅等.）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">core</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                 // generic code，glue between the pieces</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">aio</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  // 线程池模拟的异步操作，带状态机的事件驱动</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">CMakeLists</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">txt</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // cmake编译文件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pkgconfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">in</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         // pkconfig工具配置文件</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">README</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">               // readme</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中nanomsg对外暴露的接口api定义在nn.h中：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_socket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> domain, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> protocol);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_setsockopt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> level, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> option, </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                             const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">optval, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> optvallen);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_getsockopt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> level, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> option, </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                             void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">optval, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">optvallen);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_bind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">addr);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_connect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">addr);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_shutdown</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> how);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_send</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">buf, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> len, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> flags);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_recv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">buf, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> len, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> flags);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_sendmsg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> struct nn_msghdr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">msghdr, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> flags);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_recvmsg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s, struct nn_msghdr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">msghdr, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> flags);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_device</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s1, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s2);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熟悉posix socket接口api的人应该对这些接口不陌生（除了后面三个函数，以后会介绍）， 所以一个简单的服务端应答程序大致是这样的：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">char</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> buf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_socket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(AF_SP, NN_REP);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nn_bind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;tcp://*:5555&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nn_recv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s, buf, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nn_send</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;World&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nn_close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的客户端请求程序大致为：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">char</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> buf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> s </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nn_socket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(AF_SP, NN_REQ);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nn_connect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;tcp://localhost:5555&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nn_send</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nn_recv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s, buf, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">n&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, buf);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nn_close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(s);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="原理背景" tabindex="-1"><a class="header-anchor" href="#原理背景"><span>原理背景</span></a></h2><p><a href="http://www.kegel.com/c10k.html" title="The C10K Problem" target="_blank" rel="noopener noreferrer">The C10K problem</a>提出后，不仅给web服务器的代码设计开发提供了思路，也给整个网络通信的架构提出了建议和意见，于是各种eventloop层出不穷（libevent/libev/libuv/redis的ae/nginx的event等等，这样的说法可能不正确，这些代码的出现应该是伴随着C10K问题完善的）。</p><p><a href="http://book.douban.com/subject/1500149/" title="UNIX网络编程" target="_blank" rel="noopener noreferrer">《UNIX网络编程》</a>将IO模型分为五类：阻塞式IO/非阻塞式IO/IO多路复用/信号驱动式IO/异步IO（参考：<a href="http://shenxueliang.iteye.com/blog/1677194" target="_blank" rel="noopener noreferrer">《Unix系统的IO模型》</a>），而IO的多路分离及异步非阻塞这样的通信模型几乎集成在目前所有的高性能服务端程序框架中。</p><h3 id="关于io的多路分离" tabindex="-1"><a class="header-anchor" href="#关于io的多路分离"><span>关于IO的多路分离</span></a></h3><p>IO的多路分离器有select,poll,dev/poll,epoll,kqueue等，网络上已经有很多对他们的对比和解释，此处不再赘述了。</p><p>值得关注的是，从陈硕大牛的这篇<a href="http://www.cnblogs.com/Solstice/archive/2010/02/26/linux_new_syscalls.html" target="_blank" rel="noopener noreferrer">《Linux 新增系统调用的启示》</a>中可以发现linux kernel引入了timerfd,signalfd,eventfd后，带来的好处在于我不需要再自己维护一个timer结构（list或者rbtree）便可处理timeout事件了，不需要makepipe便可处理signal事件了，而eventfd不仅提供一种线程间通信方式，实际上也为用户级事件提供了接口（实际上nanomsg正是用它来处理task的）。这样我们在linux上实现一个eventloop要容易很多，通过接口创建对应事件的fd后加入到epoll池中即可，当然需要注意的是可能要设置最大打开句柄数（ulimit -n，默认的1024可能不一定够用）。</p><h3 id="关于非阻塞" tabindex="-1"><a class="header-anchor" href="#关于非阻塞"><span>关于非阻塞</span></a></h3><p>在创建文件描述符fd时，增加相应NONBLOCK标志（很多系统调用均支持额外的flags参数，比如：accept4，eventfd2，pipe2等，也可通过fcntl事后设置O_NONBLOCK），即为非阻塞了：</p><p>而在读写时，都需要对read或write包上一层while：</p><p>do {</p><p>read()/write()</p><p>} while(errno == EAGAIN  ||errno == EWOULDBLOCK || errno == EINTR);</p><h3 id="关于异步io" tabindex="-1"><a class="header-anchor" href="#关于异步io"><span>关于异步IO</span></a></h3><p>目前应该是有两类异步IO的实现方式：</p><p>一种是线程池模拟（glibc的aio：<a href="http://www.ibm.com/developerworks/linux/library/l-async/" target="_blank" rel="noopener noreferrer">http://www.ibm.com/developerworks/linux/library/l-async/</a> ；libev作者写的libeio：<a href="http://software.schmorp.de/pkg/libeio.html" target="_blank" rel="noopener noreferrer">http://software.schmorp.de/pkg/libeio.html</a> ；而libuv则是自己将线程池的实现集成到自己内部threadpool.c，然后将对文件系统的操作以及getaddrinfo()包裹于其上，实现了其文件操作及getaddrinfo()的异步化）；</p><p>另一种则是linux在2.6.22版本后自带的<a href="http://lse.sourceforge.net/io/aio.html" target="_blank" rel="noopener noreferrer">native aio</a>（nginx则是真正利用linux native aio（syscall方式）实现的异步IO；参考：<a href="http://www.pagefault.info/?p=76" target="_blank" rel="noopener noreferrer">http://www.pagefault.info/?p=76</a>）</p><h3 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h3><p>以下是几位大牛的文章，我觉得都挺不错的：</p><ol><li><a href="http://shenxueliang.iteye.com/blog/1677194" target="_blank" rel="noopener noreferrer">Unix系统的IO模型</a></li><li><a href="http://blog.yufeng.info/archives/741" target="_blank" rel="noopener noreferrer">Linux下异步IO(libaio)的使用以及性能</a></li><li><a href="http://www.pagefault.info/?p=76" target="_blank" rel="noopener noreferrer">nginx 0.8.x稳定版对linux aio的支持</a></li><li><a href="http://www.cnblogs.com/Solstice/archive/2010/02/26/linux_new_syscalls.html" target="_blank" rel="noopener noreferrer">Linux 新增系统调用的启示</a></li></ol><h2 id="敬请期待" tabindex="-1"><a class="header-anchor" href="#敬请期待"><span>敬请期待</span></a></h2><p>对nanomsg接口及代码框架了解后，不妨让我们深入下细节，探探究竟。</p><p>下一篇文章将深入实用工具类包utils内部，看看nanomsg都需要哪些基础功能？以及如何包装的？</p><p>敬请期待~</p>`,34))])}const g=n(k,[["render",p]]),o=JSON.parse(`{"path":"/blog/learning-nanomsg-1.html","title":"nanomsg源码阅读（一）","lang":"zh-CN","frontmatter":{"title":"nanomsg源码阅读（一）","tag":["nanomsg","C"],"category":["learning"],"date":"2013-09-05T11:58:53.000Z","description":"nanomsg是zeromq作者Martin Sustrik用C重写的一套具有可扩展协议的一套通信框架，具体nanomsg与zeromq的不同与改进之处及为什么要用C重写在这里有详细的描述，个人感觉C的代码风格和目录结构组织都看着舒服多了，：），另外Martin Sustrik博客（http://250bpm.com/ ）里面的每篇文章感觉都挺不错的，...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"nanomsg源码阅读（一）\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2013-09-05T11:58:53.000Z\\",\\"dateModified\\":\\"2025-11-15T10:21:25.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"abstiger\\",\\"url\\":\\"https://abstiger.com\\"}]}"],["meta",{"property":"og:url","content":"https://abstiger.com/blog/learning-nanomsg-1.html"}],["meta",{"property":"og:site_name","content":"Tiger's Website"}],["meta",{"property":"og:title","content":"nanomsg源码阅读（一）"}],["meta",{"property":"og:description","content":"nanomsg是zeromq作者Martin Sustrik用C重写的一套具有可扩展协议的一套通信框架，具体nanomsg与zeromq的不同与改进之处及为什么要用C重写在这里有详细的描述，个人感觉C的代码风格和目录结构组织都看着舒服多了，：），另外Martin Sustrik博客（http://250bpm.com/ ）里面的每篇文章感觉都挺不错的，..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-11-15T10:21:25.000Z"}],["meta",{"property":"article:tag","content":"C"}],["meta",{"property":"article:tag","content":"nanomsg"}],["meta",{"property":"article:published_time","content":"2013-09-05T11:58:53.000Z"}],["meta",{"property":"article:modified_time","content":"2025-11-15T10:21:25.000Z"}]]},"git":{"createdTime":1763202085000,"updatedTime":1763202085000,"contributors":[{"name":"mingqiang.cheng","username":"","email":"mingqiang.cheng@cloudpense.com","commits":1}]},"readingTime":{"minutes":5.4,"words":1619},"filePathRelative":"blog/learning-nanomsg-1.md","excerpt":"<p><a href=\\"http://nanomsg.org/\\" title=\\"nanomsg\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">nanomsg</a>是<a href=\\"http://zeromq.org/\\" title=\\"zeromq\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">zeromq</a>作者Martin Sustrik用C重写的一套具有可扩展协议的一套通信框架，具体nanomsg与zeromq的不同与改进之处及为什么要用C重写在<a href=\\"http://nanomsg.org/documentation-zeromq.html\\" title=\\"ifferences between nanomsg and ZeroMQ\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">这里</a>有详细的描述，个人感觉C的代码风格和目录结构组织都看着舒服多了，：），另外Martin Sustrik博客（<a href=\\"http://250bpm.com/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">http://250bpm.com/</a>&nbsp;）里面的每篇文章感觉都挺不错的，推荐关注订阅！</p>\\n","autoDesc":true}`);export{g as comp,o as data};
