import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as e,d as i,b as n,o as l}from"./app-CdpNCDY8.js";const t={};function r(h,s){return l(),e("div",null,[s[0]||(s[0]=i(`<h1 id="进度介绍" tabindex="-1"><a class="header-anchor" href="#进度介绍"><span>进度介绍</span></a></h1><p>下午拉起了协调器krcoordi，简单测试了下其与krserver、krclient之间的协调通信后，krproject的初步框架开发算是完成了！比计划中的日期延后了差不多两个礼拜，除了一些乱七八遭的原因外，还是自己的开发效率并不够高，过程中也碰到了蛮多之前未考虑进来的细节~</p><p>还是总结下这段时间的工作及后续的一些安排吧~</p><h2 id="krdb" tabindex="-1"><a class="header-anchor" href="#krdb"><span>krdb</span></a></h2><p>给krdb增加了通过mmap持久化的功能，krdb是有多个krtable构成，每个table代表了一种格式的输入数据源（定义不同渠道、不同类型的数据），而用户可以根据需要给这些输入数据定义基于单表的索引（表级索引）和贯穿多表的索引（库级索引）。这样便为后续多数据源、多统计维度的数据分析做好了数据准备~</p><p>这是我设计的mmap持久化文件的格式概览：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/* mmap file overview:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * |T_KRTable|T_KRFieldDef*iFieldCnt|T_Record*lSizeKeepValue|</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>文件头是这张表的基本信息，接下来是这张表的域描述信息 ，最后是实际的记录存储。对应索引信息并没有存储在这里，而是需要程序在加载mmap文件时，自己建立~</p>`,8)),n("more"),s[1]||(s[1]=i(`<h2 id="krrule" tabindex="-1"><a class="header-anchor" href="#krrule"><span>krrule</span></a></h2><p>为了支持半同步半异步的线程池模式分离krdb的插入与krrule的运算，需要为每个规则分析线程创建一个上下文环境context（包括数据库连接的上下文、历史统计量缓存cache、当笔统计量运算与规则分析的动态内存块dynamic memory等），而为了能做到统计量及规则修改的实时生效，这里通过比较动态内存的加载时间戳timestamp与共享内存中的配置信息刷新timestamp，来决定动态内存是否需要重新根据共享内存内容加载。</p><p>完成静态数据项和动态统计量的统计运算，目前支持的统计算法包括：sum,count,min,max,count distinct。</p><h2 id="krmsg" tabindex="-1"><a class="header-anchor" href="#krmsg"><span>krmsg</span></a></h2><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/* The message format for krproject communication:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * |msgtype(4bytes)|serverid(26bytes)|clientid(26bytes)|datasrcid(4bytes)|</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * objectkey(64bytes)|msglen(4bytes)|message(msglen bytes)|</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这便是Krproject中的消息传递统一格式：由128字节的消息头与可选择的消息内容构成。消息头依次为消息类型、server标识、client标识、数据源标识、key对象（在krcoordi中，按此key对象进行server端的consistent hashing定位）、消息长度；消息内容可选择。</p><p>目前实现的消息类型有：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> enum</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    KR_MSGTYPE_SVRON</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    KR_MSGTYPE_SVROFF</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    KR_MSGTYPE_CLION</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    KR_MSGTYPE_CLIOFF</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    KR_MSGTYPE_APPLY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    KR_MSGTYPE_REPLY</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}E_KRMsgType;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样包装的好处是后续可根据需要对消息内容进行加密、校验和、序列化等操作，不影响其他模块的消息处理。</p><h2 id="krserver" tabindex="-1"><a class="header-anchor" href="#krserver"><span>krserver</span></a></h2><p>各模块的集成，主要是配置参数的解析和事件驱动handler的编写，这里krserver可根据配置运行在单线程或线程池、单机或集群模式下，下面是server配置文件的一个样板：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[SYSTEM]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">SERVERID</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">krserver1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">DAEMONIZE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">0</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">SHMKEY</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">74561</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">DETECTMODE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LOGPATH</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/home/tiger/krproject/log</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LOGLEVEL</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">5</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">THREADCNT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">5</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">MAXEVENTS</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">1024</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[NETWORK]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">TCPPORT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">7251</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">TCPBINDADDR</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">UNIXDOMAIN</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/tmp/krserver1.domain</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">UNIXDOMAINPERM</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">755</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">CLUSTERMODE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">WEIGHTS</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">20</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">COORDDOMAIN</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">COORDPORT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">7250</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">COORDIP</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">127.0.0.1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="krcoordi" tabindex="-1"><a class="header-anchor" href="#krcoordi"><span>krcoordi</span></a></h2><p>通过consistent hashing结构组织连接到此协调器上的server；<br> 通过list结构组织连接到此协调器上的client。<br> 无论是client还是server在实际业务消息发送前都需要先发送对应的注册ON信息。<br> Client发送的APPLY信息里，如果指定了server并且该server确实存在，则直接转发至该server，否则根据objectkey一致性哈希确定server。<br> Server回复的REPLY信息里，根据对应的clientid确定转达的目的地client。</p><h2 id="krclient" tabindex="-1"><a class="header-anchor" href="#krclient"><span>krclient</span></a></h2><p>简单报文消息生成与发送测试程序。</p><h1 id="后续工作" tabindex="-1"><a class="header-anchor" href="#后续工作"><span>后续工作</span></a></h1><ol><li>程序测试（功能、异常、压力……），代码注释及日志记录完善，相关说明文档的编写；</li><li>动态库加载的方式实现自定义统计算法（比如用户可自定义获取递减次数或连续递增次数等），看了下autotools的动态库方案，虽然能做到平台无关化，但是觉得有点复杂……；</li><li>多线程的数据库连接（不同数据库的多线程编程接口并不一致，有点犹豫要不要把这块整进来……）；</li><li>历史统计量缓存的设计开发（最早考虑触发式，但是觉得会影响程序的效率，还是考虑采用“用时取值更新”的策略，具体缓存方式采用LRU算法）。</li></ol><p>PS：大段的文字总是让人头疼，后面会结合文档编写画一些图上来，相信会让大家有些直观的感觉~<br> 然后我会找个合适的时间将代码开源的，请大家小小的期待下吧，O(∩_∩)O哈哈~</p>`,19))])}const d=a(t,[["render",r]]),c=JSON.parse(`{"path":"/projects/krproject/krproject-develop-trace-3.html","title":"krproject开发进展（三）","lang":"zh-CN","frontmatter":{"order":3,"title":"krproject开发进展（三）","article":false,"date":"2012-06-16T19:24:35.000Z","description":"进度介绍 下午拉起了协调器krcoordi，简单测试了下其与krserver、krclient之间的协调通信后，krproject的初步框架开发算是完成了！比计划中的日期延后了差不多两个礼拜，除了一些乱七八遭的原因外，还是自己的开发效率并不够高，过程中也碰到了蛮多之前未考虑进来的细节~ 还是总结下这段时间的工作及后续的一些安排吧~ krdb 给krdb...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"WebPage\\",\\"name\\":\\"krproject开发进展（三）\\",\\"description\\":\\"进度介绍 下午拉起了协调器krcoordi，简单测试了下其与krserver、krclient之间的协调通信后，krproject的初步框架开发算是完成了！比计划中的日期延后了差不多两个礼拜，除了一些乱七八遭的原因外，还是自己的开发效率并不够高，过程中也碰到了蛮多之前未考虑进来的细节~ 还是总结下这段时间的工作及后续的一些安排吧~ krdb 给krdb...\\"}"],["meta",{"property":"og:url","content":"https://abstiger.com/projects/krproject/krproject-develop-trace-3.html"}],["meta",{"property":"og:site_name","content":"Tiger's Website"}],["meta",{"property":"og:title","content":"krproject开发进展（三）"}],["meta",{"property":"og:description","content":"进度介绍 下午拉起了协调器krcoordi，简单测试了下其与krserver、krclient之间的协调通信后，krproject的初步框架开发算是完成了！比计划中的日期延后了差不多两个礼拜，除了一些乱七八遭的原因外，还是自己的开发效率并不够高，过程中也碰到了蛮多之前未考虑进来的细节~ 还是总结下这段时间的工作及后续的一些安排吧~ krdb 给krdb..."}],["meta",{"property":"og:type","content":"website"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-11-15T10:21:25.000Z"}],["meta",{"property":"article:published_time","content":"2012-06-16T19:24:35.000Z"}],["meta",{"property":"article:modified_time","content":"2025-11-15T10:21:25.000Z"}]]},"git":{"createdTime":1763202085000,"updatedTime":1763202085000,"contributors":[{"name":"mingqiang.cheng","username":"","email":"mingqiang.cheng@cloudpense.com","commits":1}]},"readingTime":{"minutes":4.18,"words":1254},"filePathRelative":"projects/krproject/krproject-develop-trace-3.md","excerpt":"\\n<p>下午拉起了协调器krcoordi，简单测试了下其与krserver、krclient之间的协调通信后，krproject的初步框架开发算是完成了！比计划中的日期延后了差不多两个礼拜，除了一些乱七八遭的原因外，还是自己的开发效率并不够高，过程中也碰到了蛮多之前未考虑进来的细节~</p>\\n<p>还是总结下这段时间的工作及后续的一些安排吧~</p>\\n<h2>krdb</h2>\\n<p>给krdb增加了通过mmap持久化的功能，krdb是有多个krtable构成，每个table代表了一种格式的输入数据源（定义不同渠道、不同类型的数据），而用户可以根据需要给这些输入数据定义基于单表的索引（表级索引）和贯穿多表的索引（库级索引）。这样便为后续多数据源、多统计维度的数据分析做好了数据准备~</p>","autoDesc":true}`);export{d as comp,c as data};
