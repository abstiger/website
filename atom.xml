<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="https://abstiger.com/atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN">
  <id>https://abstiger.com/</id>
  <title>Tiger&amp;apos;s Website</title>
  <subtitle>Absolute and Simple~</subtitle>
  <updated>2025-11-22T11:25:58.775Z</updated>
  <generator>@vuepress/plugin-feed</generator>
  <link rel="self" href="https://abstiger.com/atom.xml"/>
  <link rel="alternate" href="https://abstiger.com/"/>
  <category term="exploring"/>
  <category term="learning"/>
  <category term="playing"/>
  <entry>
    <title type="text">关于开放平台的接口安全性</title>
    <id>https://abstiger.com/blog/exploring-openapi-security.html</id>
    <link href="https://abstiger.com/blog/exploring-openapi-security.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p>互联网时代，服务型企业将自己的功能服务封装成一系列API（Application Programming Interface，应用编程接口）开放出去，供第三方开发者使用，正成为一种趋势，搭建的平台也被大家称之为开放平台。</p>
]]></summary>
    <content type="html"><![CDATA[<p>互联网时代，服务型企业将自己的功能服务封装成一系列API（Application Programming Interface，应用编程接口）开放出去，供第三方开发者使用，正成为一种趋势，搭建的平台也被大家称之为开放平台。</p>
<!-- more -->
<p>本质上来说，开放平台就是暴露一系列的接口，而接口的定义其实就是：软件接口是用于两个模块间交互的共享数据边界，它提供：常量定义，数据类型及结构定义，方法描述及异常指定。</p>
<p>进程内部接口调用和机构内部跨系统的调用，因为基本在一个局域网内，相对是安全的，一般不太会考虑到安全方面的内容。</p>
<p>而开放平台则属于跨机构的接口调用了，本文主要探讨下在开放平台下的接口调用安全性问题。而关于开放平台本身的接口设计与建设过程不在本文中阐述了！</p>
<h2>问题分析</h2>
<p>正式开始前，稍微回顾下安全相关的一些术语和定义：</p>
<ul>
<li>
<p>编解码(base64）<br>
encode&amp;decode，没有秘钥的参与</p>
</li>
<li>
<p>摘要算法(md5,sha1,sha256)<br>
单向不可逆</p>
</li>
<li>
<p>对称加解密(des,3des,aes)<br>
双方约定公共秘钥，加解密速度相对较快</p>
</li>
<li>
<p>非对称加解密(rsa)<br>
公钥加密，私钥解密，加解密速度相对较慢</p>
</li>
<li>
<p>数字签名和证书(sha256rsa)<br>
私钥加签，公钥验签；签名为摘要+非对称加密；证书则通过再增加一个CA中心，公开认证签名的来源及合法性</p>
</li>
</ul>
<h3>why?</h3>
<p>因为跨机构或者说基于互联网的接口调用，在物理上报文内容需要经过多个设备中转，这其中便存在被伪造、窃听、劫持和篡改的可能！</p>
<p>如何确保接口的安全传输和信息的准确传递是对接口设计者和开放平台建设者的一种考验！</p>
<h3>what?</h3>
<p>追根溯源，其实关于接口安全的本质，即什么样的接口是安全的？可以总结为以下三点：</p>
<ol>
<li>
<p>避免监听风险，接口内容不能被他人知晓
因为有中间设备的路由，存在被监听的可能，但我们希望接口内容不被第三方知道！</p>
</li>
<li>
<p>避免伪造风险，接口的发送者身份确认
即认证（Authentication）接受者需要确认到底是谁发的消息，发送者需要表明自己的身份</p>
</li>
<li>
<p>避免篡改风险，接口内容没有被篡改过
接收者接收到的接口内容需要确保是发送者发送的，需确保不曾被中间渠道修改过</p>
</li>
</ol>
<h3>how?</h3>
<p>那如何做到开放平台的接口调用安全呢？</p>
<p>从非技术层面出发，由以上几点我们可以知道，影响接口和消息传递安全的其实是中间层！最有效直接的沟通当然是面对面的沟通，加入了中间媒介就增加了沟通的成本和安全的风险。<strong>拉专线</strong>便是最直接有效的方式，也是目前很多大机构间接口调用普遍采用的方式！但拉专线的做法并不是真正开放的、互联网的做法，而且拉专线本身是有业务费用的，而程序员很多时候的主要作用和任务就是要减少业务费用！</p>
<p>如何从技术层面实现开放平台的接口调用安全？</p>
<ul>
<li>
<p>避免窃听风险<br>
在开放的公网传输，窃听其实是无法避免的，我们能做的就是即使被窃听了，你也拿不到真正有效的信息，简而言之就是要保证接口报文不能以明文的方式在网络上传输！ 实现时需要考虑密钥的交换和传输时的报文加解密！
<strong>SSL/TLS</strong>就是为此而生的！协议本身的实现也很精妙，结合了非对称加密和对称加密的过程，握手阶段采用非对称加解密协商会话密钥，传输阶段采用对称加解密传输报文。
参考文档：<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="noopener noreferrer">SSL/TLS协议运行机制的概述</a></p>
</li>
<li>
<p>避免伪造风险<br>
需要能够识别出发送者的身份，即需要一个认证（Authentication）的过程，基于http协议的认证方式大致有basic，digest，api-key，oauth2等等。
参考文档：<a href="http://www.cnblogs.com/Irving/p/4964489.html" target="_blank" rel="noopener noreferrer">关于 RESTFUL API 安全认证方式的一些总结</a></p>
</li>
<li>
<p>避免篡改风险<br>
思路是发送者对接口的<strong>全部内容</strong>（有些实现是对<strong>部分重要字段</strong>，并不安全也增加了实现复杂度，不推荐）形成校验和，接收者同样对收到的接口全部内容计算校验和并与接收到的校验和做比对，一致则认为接口未被篡改！身份证和卡号的最后一位其实都是校验和算法或者摘要算法在我们身边的实际应用！参考文档：<a href="https://zh.wikipedia.org/wiki/%E6%A0%A1%E9%AA%8C%E5%92%8C" target="_blank" rel="noopener noreferrer">校验和</a><br>
可以看到，数字签名算法（签名过程简介：对全报文进行摘要后，再用表明身份的私钥进行非对称加密，一般为Sha256WithRSA）其实是综合了以上的第二点（避免伪造风险）和第三点（避免篡改风险）！参考资料：<a href="http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html" target="_blank" rel="noopener noreferrer">数字签名是什么？</a></p>
</li>
</ul>
<h2>方案调研</h2>
<p>开放平台的接口调用，一般要求语言无关性，https协议成为传输层协议首选，而json以其简洁、直观、小巧基本成为报文协议的首选。其他在金融领域应用较多的有在tcp/ip传输协议之上的8583报文协议，swift的MXs报文协议等，接触过这些协议的开发者大多被其晦涩难懂、各种弯弯绕折磨的痛苦不堪~</p>
<p>但基于<strong>https+json</strong>的开放平台搭建又分两种方式，笔者将其划分为以下两类：</p>
<ul>
<li>
<p>gateful型<br>
提供固定网关端点endpoint，统一采用POST方法进行接口调用，报文中包含交易标识代码transcode字段</p>
</li>
<li>
<p>restful型<br>
以endpoint代表资源标识，以get/post/put/delete等http method代表对资源的增删改查等操作，requestParam及requestBody中一般不再包含交易标识字段，实际上可以理解为transcode=endpoint+method</p>
</li>
</ul>
<h3>机构对机构：</h3>
<p>建议采用gateful，restful设计刚出来的时候，几乎所有人都拥抱了起来，但如果你细想一下就会发现restful的设计在接口安全的实现上就会很难！难点主要在对全接口内容的摘要计算上，对于restful设计，http method及endpoint都应属于接口内容的一部分！<br>
我们可以看到有很多restful类型的开放平台的待签名源串的选取方案是：<code>Method + Endpoint + RequestParam</code>的 key=value 方式，这里<code>RequestBody</code>成了最大的问题，几乎所有的基于restful设计的签名方案里都忘了<code>RequestBody</code>的存在，不是他们忘了，是他们实在不知道如何处理<code>RequestBody</code>...</p>
<h3>机构对个人：</h3>
<p>建议采用restful，主要原因是机构对个人很难做到双向签名，不可能在每个用户的手机或电脑终端上存放私钥（当然有很多程序是拿电脑的mac地址或者手机的IMEI号码作为客户端标识），也不可能在机构端存放所有用户的公钥。<br>
这里一般是忽略了报文的篡改风险的，但篡改难度因为https的存在加大了很多，报文的内容因为是加密的，在不知道会话密钥的情况下，成功修改报文内容的可能微乎其微（而且http协议本身也有content-length的header，起到了一定的摘要作用）。</p>
<h3>方案总结</h3>
<p>一句话总结开放平台的安全方案设计就是： <strong>https是必须，机构对机构建议采用数字签名或证书，机构对个人采用认证即可！</strong></p>
<h2>案例参考</h2>
<p>笔者调研了诸多的开放平台，不得不说的是，很多开放平台的接口安全设计是有瑕疵的：要么很不友好，让对接开发者很头大；要么是存在一定安全隐患的。反例就不列举了！<br>
这里我们选取几个个人觉得很不错的开放平台案例，供大家参考学习！</p>
<ul>
<li><a href="https://docs.open.alipay.com" target="_blank" rel="noopener noreferrer">Alipay的开放平台</a>  机构对机构, Gateful，采用<a href="https://docs.open.alipay.com/291/" target="_blank" rel="noopener noreferrer">数字签名</a></li>
<li><a href="https://developer.paypal.com/docs/api/overview/" target="_blank" rel="noopener noreferrer">Paypal的开放平台</a>  机构对个人, Restful，通过<a href="https://developer.paypal.com/docs/api/overview/#authentication-and-authorization" target="_blank" rel="noopener noreferrer">Oauth2+JWT方式认证</a> 教科书式的开放平台设计！</li>
<li><a href="https://stripe.com/docs/api" target="_blank" rel="noopener noreferrer">Stripe的开放平台</a>  机构对个人, Restful，通过<a href="https://stripe.com/docs/api#authentication" target="_blank" rel="noopener noreferrer">Api+Key的方式认证</a></li>
</ul>
]]></content>
    <category term="exploring"/>
    <published>2018-01-17T16:30:28.000Z</published>
  </entry>
  <entry>
    <title type="text">hello world</title>
    <id>https://abstiger.com/blog/hello-world.html</id>
    <link href="https://abstiger.com/blog/hello-world.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p>Hello world！</p>
<p>Tiger’s coming~</p>
<p>Let’s make things absolute and simple!</p>
]]></summary>
    <content type="html"><![CDATA[<p>Hello world！</p>
<p>Tiger’s coming~</p>
<p>Let’s make things absolute and simple!</p>
<!-- more -->
<p>虽然它现在还很粗糙，如同博主的技术和人品，</p>
<p>但是您会把它加入收藏夹或者订阅本博的，对不对？</p>
<p>欢迎各种技术交流与指导，再次谢谢大家光顾！</p>
]]></content>
    <published>2012-01-05T17:30:10.000Z</published>
  </entry>
  <entry>
    <title type="text">HyperDex浅析之hyperspacehashing</title>
    <id>https://abstiger.com/blog/learning-hyperdex-1.html</id>
    <link href="https://abstiger.com/blog/learning-hyperdex-1.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p>前段时间在微博上看到有人介绍这个<a href="http://hyperdex.org/" title="hyperdex" target="_blank" rel="noopener noreferrer">HyperDex</a>，与现在普遍的key-value存储稍有些不同的是：它不仅支持按key的查找，还支持按value里的一个或多个属性值来查找。有人说这就是“DB搜索化，搜索DB化”，还没完全理解这句话的含义，不过这确实给人耳目一新的感觉。</p>
]]></summary>
    <content type="html"><![CDATA[<p>前段时间在微博上看到有人介绍这个<a href="http://hyperdex.org/" title="hyperdex" target="_blank" rel="noopener noreferrer">HyperDex</a>，与现在普遍的key-value存储稍有些不同的是：它不仅支持按key的查找，还支持按value里的一个或多个属性值来查找。有人说这就是“DB搜索化，搜索DB化”，还没完全理解这句话的含义，不过这确实给人耳目一新的感觉。</p>
<!-- more -->
<h2>项目简介</h2>
<p>最吸引人眼球的的一条消息就是HyperDex与Redis的benchmark对比，各方面都领先，查询的速度更是Redis的14倍……，随后有人在redis的论坛里发了<a href="http://groups.google.com/group/redis-db/browse_thread/thread/378a32de50a782c5#" title="HyperDex vs Redis" target="_blank" rel="noopener noreferrer">HyperDex vs Redis</a>的贴，antirez对那个性能测试的结果提了些想法，提出会在2.6 RC1后尝试引入多线程入redis，并且表示 “I see very well such a project.”，哈哈~</p>
<p>整个代码功能上大致分四块：</p>
<ol>
<li>核心算法hyperspacehashing；</li>
<li>客户端模块hyperclient；</li>
<li>负责zone分配（针对客户端操作请求）和管理（针对服务端节点变化）的协调器hypercoordinator（python实现）；</li>
<li>服务端模块hyperdemon、hyperdex、hyperdisk（还没有细看，可能划分的有些问题，姑且先放在一起）。</li>
</ol>
<h2>源码阅读</h2>
<p>稍微详细地看了下hyperspacehashing的介绍和源码，做下记录：</p>
<h3>理论分析</h3>
<p>目前大部分的key-value存储在遇到非key查找，按value中的某个属性attribute查找时，基本是采取遍历scan的方式，这是key-value存储系统极力避免的事情，但是随着业务需求的发展，这个似乎不可避免；</p>
<p>传统的关系型数据库如果需要在非索引字段上查找的话，第一反应就是给该字段加上索引（广告一下：krdb就是参考了这个方法，实际上就是再以查找字段为key建立一个新的动态hashtable），可如果我的查询是所有字段的排列组合呢？我们不可能为每一种排列组合建立一个索引。</p>
<p>hyperspacehashing提供了一种方案：对对象或记录中所有可能需要查找的属性attribute字段进行hash，每一个属性字段对应空间中的一个维度dimension，hash值即为该维度上的坐标值，再对计算好的各个维度上的hash值混合加工（interlace）成一个凝聚值（conglomerate hash），而这个值便是这个对象或记录在整个由属性值构成的N维空间中的坐标点（coordinate point）。这样所有的对象都以坐标点形式都被散列分布在这个N维空间中了。</p>
<p>那一个指定一个或多个属性字段的精确或范围查找（search），具体又是如何执行的呢？</p>
<p>HyperDex将这样的一个属性字段排列组合的查询同样映射到一个对应的查询平面（文中称为hyperplane，不知道这样翻译是否合理，实际上在一个三维空间里，如果指定一个维度查询，那是一个平面；而如果指定两个维度，便是一条直线了；而如果指定三个精确维度，那便唯一确定一点了），HyperDex再从这个平面划过的区域（region）里匹配满足条件的一个个点对象。具体这个匹配满足的过程是先看这个对象的坐标是否与查询平面相交，再逐个判断key和value是否相等。这个与链式冲突法的先hash定位，再在链中逐个精确比较异曲同工。</p>
<h3>代码实现</h3>
<p>具体代码实现时，用了两种对象坐标表示方法：</p>
<ul>
<li>一种是prefix（Hash-calculating objects that work for the replication layer.）；</li>
<li>一种是mask（Hash-calculating objects that work for the disk layer.）。</li>
</ul>
<p>此处请先不要问我为什么要这么做……</p>
<h4>prefix.h,prefix.cc</h4>
<p>下面是prefix类中坐标coordinate类里的数据成员：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint8_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> prefix;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> /*维度数，对一个全属性字段对象而言实际上这个值都是N*/</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint64_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> point;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> /*这个便是上面提到的N维空间坐标值了*/</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>下面这个判断是否相交的函数揭示了上面两个类成员的具体含义：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">bool</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">hyperspacehashing :: prefix :: coordinate :: </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">intersects</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> coordinate</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> other) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">const</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint64_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> mask </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> lookup_msb_mask</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B">std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">min</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(prefix, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">prefix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (mask </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> point) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (mask </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">point</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先取两个坐标的最小维度值（公共的维度），通过常量数组lookup_msb_mask[]（从高位到低位依次变1，由64个0到64个1），完成prefix维度数到64位维度的横向描述mask，而将point值与此mask做“与”操作，得到坐标在维度上的坐标值（因为再hash的原因，实际这里仅能通过0/1粗略表示是否存在该维度坐标）,如果两个坐标公共的维度坐标相等，则他们相交。
有点抽象，三维空间里举例如下：平面x=5与点x=4,y=2,z=1不相交，因为在他们的公共维度x上5！=4,；同样平面x=5与y=3,z=4的直线相交，因为他们不存在公共的维度，即都为0。
这里还定义了查询坐标子类search_coordinate。</p>
<h4>mask.h,mask.cc</h4>
<p>下面是mask类中坐标coordinate类里的数据成员：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">    /*primary与key对应*/</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint64_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> primary_mask;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint64_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> primary_hash;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">    /*secondary与value对应*/</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint64_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> secondary_lower_mask;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint64_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> secondary_lower_hash;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint64_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> secondary_upper_mask;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint64_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> secondary_upper_hash;</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了继续保持key-value存储对key查找的高效性，HyperDex将key和value分开，便有了这儿对应key的primary_hash和对应value的secondary_hash，其他方法与上类似。</p>
<h4>range_match.h,rang_match.cc</h4>
<p>提供构成prefix类的查询坐标子类search_coordinate主要方法match()的范围匹配类range_match。</p>
<h4>search.h，search.cc</h4>
<p>上面两种坐标体系的intersects()方法，都只是起到了数据查找的初步过滤，还需要精确的实际值比较，search类做的便是这个精确的值比较，被search类match()上的就是真正查找要返回的对象了。</p>
<h4>hashes.h,hashes.cc,cfloat.h,cfloat.cc</h4>
<p>默认提供两种hash算法：精确等于匹配时采用google的CityHash64()，需要范围匹配时的cfloat()和cfloat_range()，这里的范围匹配字段只支持64位存储以下的数字属性字段。</p>
<h4>bithacks.h</h4>
<p>这里不仅提供了lookup_msb_mask常量数组，还提供了用来对各维度上的hash值再hash的interlace相关函数,prefix坐标体系里用的upper_interlace()，mask坐标体系里用的是double_lower_interlace()。</p>
<h2>总结</h2>
<p>感觉这个东东真的还蛮厉害的，至少给拓宽了nosql的视野，期待它的实际应用！不过有很多的第三方依赖，实地编译安装起来感觉不是很方便。</p>
<p>本来还打算实地操作感受一下的，可是现在还没有提供ubuntu的二进制安装包，尝试源码编译，可是卡在了它libe依赖包上了，竟然要求必须是x86_64……，自作聪明的暴力注掉后，atomic_op.h编译报错……，难道只能运行在64位机上？</p>
<p>后面尝试将region，node，zone，space，subspace之间的关系梳理清楚，还有那个value-dependent chaining的replication技术，看介绍似乎是有用version做控制的乐观锁方式。</p>
<p>比较粗线条的一个介绍，很多的概念和代码细节自己都还没有完全理解，错误之处，还请指正。</p>
]]></content>
    <category term="learning"/>
    <published>2012-03-01T18:35:42.000Z</published>
  </entry>
  <entry>
    <title type="text">nanomsg源码阅读（一）</title>
    <id>https://abstiger.com/blog/learning-nanomsg-1.html</id>
    <link href="https://abstiger.com/blog/learning-nanomsg-1.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p><a href="http://nanomsg.org/" title="nanomsg" target="_blank" rel="noopener noreferrer">nanomsg</a>是<a href="http://zeromq.org/" title="zeromq" target="_blank" rel="noopener noreferrer">zeromq</a>作者Martin Sustrik用C重写的一套具有可扩展协议的一套通信框架，具体nanomsg与zeromq的不同与改进之处及为什么要用C重写在<a href="http://nanomsg.org/documentation-zeromq.html" title="ifferences between nanomsg and ZeroMQ" target="_blank" rel="noopener noreferrer">这里</a>有详细的描述，个人感觉C的代码风格和目录结构组织都看着舒服多了，：），另外Martin Sustrik博客（<a href="http://250bpm.com/" target="_blank" rel="noopener noreferrer">http://250bpm.com/</a>&nbsp;）里面的每篇文章感觉都挺不错的，推荐关注订阅！</p>
]]></summary>
    <content type="html"><![CDATA[<p><a href="http://nanomsg.org/" title="nanomsg" target="_blank" rel="noopener noreferrer">nanomsg</a>是<a href="http://zeromq.org/" title="zeromq" target="_blank" rel="noopener noreferrer">zeromq</a>作者Martin Sustrik用C重写的一套具有可扩展协议的一套通信框架，具体nanomsg与zeromq的不同与改进之处及为什么要用C重写在<a href="http://nanomsg.org/documentation-zeromq.html" title="ifferences between nanomsg and ZeroMQ" target="_blank" rel="noopener noreferrer">这里</a>有详细的描述，个人感觉C的代码风格和目录结构组织都看着舒服多了，：），另外Martin Sustrik博客（<a href="http://250bpm.com/" target="_blank" rel="noopener noreferrer">http://250bpm.com/</a>&nbsp;）里面的每篇文章感觉都挺不错的，推荐关注订阅！</p>
<!-- more -->
<h2>框架简介</h2>
<p>因为nanomsg还处于开发测试阶段，代码量还不是十分庞大，文档和注释也不够全面，于是想通过这一系列博客，一方面记录下我对nanomsg当前源码（<a href="https://github.com/250bpm/nanomsg" target="_blank" rel="noopener noreferrer">https://github.com/250bpm/nanomsg</a>）的阅读过程，同时也学习下一个好的开源项目的代码组织及开发过程。</p>
<h2>源码组织</h2>
<p>首先看下nanomsg的src目录：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">nn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                 // nanomsg对外暴露的接口api</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">transport</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">          // 通信层定义，，目的应该是想暴露给用户以实现可扩展，但目前还包含utils下头文件……</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">inproc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">             // 一种transport，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">ipc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                // 一种transport，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">tcp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                // 一种transport，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">protocol</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">           // 协议层定义，目的应该是想暴露给用户以实现可扩展，但目前还包含utils下头文件……</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">reqrep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">             // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">pubsub</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">             // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">bus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">pair</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">               // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">pipeline</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">           // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">survey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">h</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">             // 一种protocol，安装到include/nanomsg下</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">utils</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                // 实用工具包，包含基本数据结构（list，queue，hash）互斥及原子操作（mutex，atomic）等</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">transports</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">           // 通信层实现，包括（inproc:进程内通信；ipc:进程间通信；tcp：tcp通信）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">protocols</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">            // 协议层实现，包括（REQ/REP:请求/应答；PUB/SUB:发布订阅等.）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">core</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                 // generic code，glue between the pieces</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">aio</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">/</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                  // 线程池模拟的异步操作，带状态机的事件驱动</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">CMakeLists</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">txt</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">       // cmake编译文件</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">pkgconfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">in</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">         // pkconfig工具配置文件</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">README</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">               // readme</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中nanomsg对外暴露的接口api定义在nn.h中：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_socket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> domain, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> protocol);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_setsockopt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> level, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> option, </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">                             const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">optval, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> optvallen);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_getsockopt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> level, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> option, </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">                             void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">optval, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">size_t</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">optvallen);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_bind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">addr);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_connect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">addr);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_shutdown</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> how);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_send</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">buf, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> len, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> flags);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_recv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">buf, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> len, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> flags);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_sendmsg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> struct nn_msghdr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">msghdr, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> flags);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_recvmsg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s, struct nn_msghdr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">msghdr, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> flags);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">NN_EXPORT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_device</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s1, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s2);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熟悉posix socket接口api的人应该对这些接口不陌生（除了后面三个函数，以后会介绍）， 所以一个简单的服务端应答程序大致是这样的：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">char</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> buf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_socket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(AF_SP, NN_REP);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_bind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(s, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"tcp://*:5555"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_recv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(s, buf, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_send</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(s, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"World"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(s);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的客户端请求程序大致为：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">char</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> buf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> s </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_socket</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(AF_SP, NN_REQ);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_connect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(s, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"tcp://localhost:5555"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_send</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(s, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"Hello"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_recv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(s, buf, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"Hello </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">%s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">n"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, buf);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(s);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>原理背景</h2>
<p><a href="http://www.kegel.com/c10k.html" title="The C10K Problem" target="_blank" rel="noopener noreferrer">The C10K problem</a>提出后，不仅给web服务器的代码设计开发提供了思路，也给整个网络通信的架构提出了建议和意见，于是各种eventloop层出不穷（libevent/libev/libuv/redis的ae/nginx的event等等，这样的说法可能不正确，这些代码的出现应该是伴随着C10K问题完善的）。</p>
<p><a href="http://book.douban.com/subject/1500149/" title="UNIX网络编程" target="_blank" rel="noopener noreferrer">《UNIX网络编程》</a>将IO模型分为五类：阻塞式IO/非阻塞式IO/IO多路复用/信号驱动式IO/异步IO（参考：<a href="http://shenxueliang.iteye.com/blog/1677194" target="_blank" rel="noopener noreferrer">《Unix系统的IO模型》</a>），而IO的多路分离及异步非阻塞这样的通信模型几乎集成在目前所有的高性能服务端程序框架中。</p>
<h3>关于IO的多路分离</h3>
<p>IO的多路分离器有select,poll,dev/poll,epoll,kqueue等，网络上已经有很多对他们的对比和解释，此处不再赘述了。</p>
<p>值得关注的是，从陈硕大牛的这篇<a href="http://www.cnblogs.com/Solstice/archive/2010/02/26/linux_new_syscalls.html" target="_blank" rel="noopener noreferrer">《Linux 新增系统调用的启示》</a>中可以发现linux kernel引入了timerfd,signalfd,eventfd后，带来的好处在于我不需要再自己维护一个timer结构（list或者rbtree）便可处理timeout事件了，不需要makepipe便可处理signal事件了，而eventfd不仅提供一种线程间通信方式，实际上也为用户级事件提供了接口（实际上nanomsg正是用它来处理task的）。这样我们在linux上实现一个eventloop要容易很多，通过接口创建对应事件的fd后加入到epoll池中即可，当然需要注意的是可能要设置最大打开句柄数（ulimit -n，默认的1024可能不一定够用）。</p>
<h3>关于非阻塞</h3>
<p>在创建文件描述符fd时，增加相应NONBLOCK标志（很多系统调用均支持额外的flags参数，比如：accept4，eventfd2，pipe2等，也可通过fcntl事后设置O_NONBLOCK），即为非阻塞了：</p>
<p>而在读写时，都需要对read或write包上一层while：</p>
<p>do {</p>
<p>read()/write()</p>
<p>} while(errno == EAGAIN &nbsp;||errno == EWOULDBLOCK ||&nbsp;errno == EINTR);</p>
<h3>关于异步IO</h3>
<p>目前应该是有两类异步IO的实现方式：</p>
<p>一种是线程池模拟（glibc的aio：<a href="http://www.ibm.com/developerworks/linux/library/l-async/" target="_blank" rel="noopener noreferrer">http://www.ibm.com/developerworks/linux/library/l-async/</a>&nbsp;；libev作者写的libeio：<a href="http://software.schmorp.de/pkg/libeio.html" target="_blank" rel="noopener noreferrer">http://software.schmorp.de/pkg/libeio.html</a>&nbsp;；而libuv则是自己将线程池的实现集成到自己内部threadpool.c，然后将对文件系统的操作以及getaddrinfo()包裹于其上，实现了其文件操作及getaddrinfo()的异步化）；</p>
<p>另一种则是linux在2.6.22版本后自带的<a href="http://lse.sourceforge.net/io/aio.html" target="_blank" rel="noopener noreferrer">native aio</a>（nginx则是真正利用linux native aio（syscall方式）实现的异步IO；参考：<a href="http://www.pagefault.info/?p=76" target="_blank" rel="noopener noreferrer">http://www.pagefault.info/?p=76</a>）</p>
<h3>参考资料</h3>
<p>以下是几位大牛的文章，我觉得都挺不错的：</p>
<ol>
<li><a href="http://shenxueliang.iteye.com/blog/1677194" target="_blank" rel="noopener noreferrer">Unix系统的IO模型</a></li>
<li><a href="http://blog.yufeng.info/archives/741" target="_blank" rel="noopener noreferrer">Linux下异步IO(libaio)的使用以及性能</a></li>
<li><a href="http://www.pagefault.info/?p=76" target="_blank" rel="noopener noreferrer">nginx 0.8.x稳定版对linux aio的支持</a></li>
<li><a href="http://www.cnblogs.com/Solstice/archive/2010/02/26/linux_new_syscalls.html" target="_blank" rel="noopener noreferrer">Linux 新增系统调用的启示</a></li>
</ol>
<h2>敬请期待</h2>
<p>对nanomsg接口及代码框架了解后，不妨让我们深入下细节，探探究竟。</p>
<p>下一篇文章将深入实用工具类包utils内部，看看nanomsg都需要哪些基础功能？以及如何包装的？</p>
<p>敬请期待~</p>
]]></content>
    <category term="learning"/>
    <published>2013-09-05T11:58:53.000Z</published>
  </entry>
  <entry>
    <title type="text">nanomsg源码阅读（二）</title>
    <id>https://abstiger.com/blog/learning-nanomsg-2.html</id>
    <link href="https://abstiger.com/blog/learning-nanomsg-2.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p>上一篇 <a href="./learning-nanomsg-1">nanomsg源码阅读（一）</a> 简单介绍了下nanomsg的代码框架。这篇开始，我将深入代码细节，从基础的实用工具类开始一窥nanomsg的真面目。</p>
]]></summary>
    <content type="html"><![CDATA[<p>上一篇 <a href="./learning-nanomsg-1">nanomsg源码阅读（一）</a> 简单介绍了下nanomsg的代码框架。这篇开始，我将深入代码细节，从基础的实用工具类开始一窥nanomsg的真面目。</p>
<!-- more -->
<h2>精细类型定义：int.h</h2>
<p><a href="http://stackoverflow.com/questions/14515874/difference-between-int32-int-int32-t-int8-and-int8-t" target="_blank" rel="noopener noreferrer">stackoverflow</a>上有人回答了关于int和精细类型的差异，C程序员还是推荐在知道具体长度或需要明确具体长度时用精细类型取代int。</p>
<p>windows下老版本的MSVC没有定义stdint.h，需要自己包装；Solaris 和 OpenVMS下定义在&lt;inttypes.h&gt;里；posix下采用&lt;stdint.h&gt;头文件。</p>
<h2>windows相关：win.h</h2>
<p>包含了windows下的几个头文件，同时define了ssize_t为int</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> &lt;windows.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> &lt;winsock2.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> &lt;mswsock.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> &lt;process.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> &lt;ws2tcpip.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> ssize_t</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> int</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--more-->
<h2>两个常用宏定义：</h2>
<h3>fast.h</h3>
<p>对应linux kernel里的LIKELY和UNLIKELY，martin专门写了篇<a href="http://250bpm.com/blog:6" target="_blank" rel="noopener noreferrer">博客</a>，说明为什么他要取名为nn_fast和nn_slow，而不用likely和unlikely，：）</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#if</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> defined</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> __GNUC__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2">||</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> defined</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> __llvm__</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_fast</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">__builtin_expect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ((x), </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_slow</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">__builtin_expect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ((x), </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#else</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_fast</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) (x)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_slow</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) (x)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#endif</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3>cont.h</h3>
<p>这是nanomsg对containerof的定义：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_cont</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">member</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">        (ptr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">?</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ((type</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) (((</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">char*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) ptr) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">-</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> offsetof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(type, member))) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>对比linux kernel里的container_of：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> container_of</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">member</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) ({ </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">        const</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> typeof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">( ((type </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">member</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">__mptr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (ptr);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">        (type </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)( (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">char</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)__mptr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">-</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> offsetof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(type,member) );})</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>是的，它去掉了第一行，而typeof正是是gcc内建的，去掉以后便达到编译器无关了，可是到底能不能去掉呢？</p>
<p><a href="http://stackoverflow.com/questions/13450292/the-definition-of-container-of-macro" target="_blank" rel="noopener noreferrer">stackoverflow上</a>有人问了我想问的问题，答案是内核版本多了编译时的类型检查，更为安全而已。</p>
<h2>网路流处理：wire.h wire.c</h2>
<p>网络协议字节序为big endian，所以也称big endian为网络字节序，即：最高字节在地址最低位，最低字节在地址最高位，一次排列，较符合人们阅读习惯。</p>
<p>关于字节序内容可参考wiki：http://en.wikipedia.org/wiki/Endianness</p>
<p>nn_gets 读取网路流中两个字节入uint16_t 结构中</p>
<p>nn_puts 将uint16_t 结构放入网路流中</p>
<p>nn_getl 读取网路流中四个字节入uint32_t 结构中</p>
<p>nn_putl 将uint32_t 结构放入网路流中</p>
<p>nn_getll 读取网路流中四个字节入uint64_t 结构中</p>
<p>nn_putll 将uint64_t 结构放入网路流中</p>
<h2>错误处理：err.h err.c</h2>
<p>nanomsg的错误代码完全采用posix标准的错误代码errno，这样的处理方式，让函数看起来更简洁，更易懂。</p>
<h2>数据结构</h2>
<h3>双向链表：list.h list.c</h3>
<p>内核版本的翻版，嵌入式链表</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_list_item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_list_item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_list_item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_list_item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">first</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_list_item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">last</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3>队列：queue.h queue.c</h3>
<p>单向链表实现</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue_item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue_item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue_item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue_item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">tail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3>哈希表：hash.h hash.c</h3>
<p>链式冲突法，rehash采用double slots方法，hash函数也是比较简单，注释说以后可能会挑一下。</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_hash_item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> key;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_list_item</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_hash</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> slots;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> items;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_list</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">array</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>时间相关</h2>
<h3>时钟管理：clock.h clock.c</h3>
<p>主要采用的是rdtsc（http://en.wikipedia.org/wiki/Rdtsc）指令，如果不支持rdtsc指令，则采用nn_clock_time()函数，</p>
<p>在windows上采用QueryPerformanceFrequency() QueryPerformanceCounter() ；在MacOS X上采用mach_absolute_time()；</p>
<p>如果存在clock_gettime()函数则采用之；如果存在gethrtime()函数则采用之&nbsp;；万般无赖之下，采用gettimeofday()函数，注释是说这个函数在某些系统下会运行的比较慢。</p>
<p>当然，通过wiki（http://en.wikipedia.org/wiki/Rdtsc）和陈硕大牛写的一篇<a href="http://blog.csdn.net/solstice/article/details/5196544" target="_blank" rel="noopener noreferrer">《多核时代不宜再用 x86 的 RDTSC 指令测试指令周期和时间》</a>，个人觉得martin这样的写法似乎并不准确，应该果断抛弃rdtsc！</p>
<p>此clock主要用在timeout的处理上！</p>
<h3>休眠操作：sleep.h sleep.c</h3>
<p>windows下调用Sleep()，否则调用nanosleep()。</p>
<h3>性能统计：stopwatch.h stopwatch.c</h3>
<p>nn_stopwatch_init 函数用在统计开始前；nn_stopwatch_term 函数用在统计结束时，返回值即为统计运行时间，以微秒（1/1000000秒）为单位</p>
<p>windows下采用QueryPerformanceFrequency()/QueryPerformanceCounter()；其他则采用gettimeofday()，这儿感觉似乎与clock有些重复，也许作者想要的是能以微秒为单位吧。</p>
<h2>线程相关</h2>
<h3>全局锁：glock.h glock.c</h3>
<p>对nanomsg库的全局锁，windows上采用CriticalSection；linux上采用mutex。用在core中！</p>
<h3>互斥量：mutex.h mutex.c</h3>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_mutex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    #ifdef</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> NN_HAVE_WINDOWS</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    CRITICAL_SECTION mutex;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> //windows下采用CRITICAL_SECTION封装mutex</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    #else</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF">    pthread_mutex_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> mutex;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> //*nix下采用posix互斥量</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    #endif</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3>原子操作：atomic.h atomic.c</h3>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#if</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> defined</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> NN_HAVE_WINDOWS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "win.h"</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> NN_ATOMIC_WINAPI</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#elif</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> NN_HAVE_ATOMIC_SOLARIS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> &lt;atomic.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> NN_ATOMIC_SOLARIS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#elif</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> defined NN_HAVE_GCC_ATOMIC_BUILTINS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> NN_ATOMIC_GCC_BUILTINS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#else</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "mutex.h"</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> NN_ATOMIC_MUTEX</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_atomic</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    #if</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> defined</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> NN_ATOMIC_MUTEX</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_mutex</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    #endif</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    volatile</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> n;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>windows和solaris下均有对应的原子操作函数；其他平台可采用gcc<a href="http://gcc.gnu.org/onlinedocs/gcc-4.3.5/gcc/Atomic-Builtins.html" target="_blank" rel="noopener noreferrer">内建原子操作</a>：__sync_fetch_and_add()/__sync_fetch_and_sub()；否则，就需要重量级的互斥量mutex包装了。</p>
<h3>信号量：sem.h sem.c</h3>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#if</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> defined</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> NN_HAVE_OSX</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> &lt;pthread.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_sem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF">    pthread_mutex_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> mutex;</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF">    pthread_cond_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> cond;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> signaled;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#elif</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> defined NN_HAVE_WINDOWS</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "win.h"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_sem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    HANDLE h;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#elif</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> defined NN_HAVE_SEMAPHORE</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> &lt;semaphore.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_sem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">    sem_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> sem;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#endif</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>即如果在MacOS X机器上将采用互斥量+条件变量实现信号量的PV操作，google了一下，发现是MacOS X只支持有名信号量而不支持无名信号量（http://lists.apple.com/archives/darwin-kernel/2005/Dec/msg00022.html）。</p>
<p>BTW：链接文章里提到的包装方法应该更标准：</p>
<blockquote>
<p>The first thing you should do is #include &lt;unistd.h&gt; and conditionalize your use of POSIX semaphores on the manifest constant _POSIX_SEMAPHORES, e.g.:</p>
</blockquote>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> ((</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">_POSIX_SEMAPHORES</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 200112</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75">L</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">/* This platform fully supports POSIX semaphores */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#else</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#if</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> defined</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">__APPLE__</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">/* This platform can support POSIX named semaphores, but not unnamed semaphores */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#else</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">/* this platform requires that I Google code for P/V semaphores and include it here */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#endif</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">#endif</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>thread.h thread.c thread_win.h thread_win.c thread_posix.h thread_posix.c</p>
]]></content>
    <category term="learning"/>
    <published>2013-09-13T16:36:33.000Z</published>
  </entry>
  <entry>
    <title type="text">nanomsg源码阅读（三）</title>
    <id>https://abstiger.com/blog/learning-nanomsg-3.html</id>
    <link href="https://abstiger.com/blog/learning-nanomsg-3.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p>上一篇 <a href="./learning-nanomsg-2">nanomsg源码阅读（二）</a> 介绍了nanomsg的实用工具类utils模块，这篇将试图解析下nanomsg最核心的aio（即用线程池模拟带状态机的异步IO）模块，当然这里的IO是广义上的IO，包含了用户自定义事件的输入输出，后面的分析中我们会看到。</p>
]]></summary>
    <content type="html"><![CDATA[<p>上一篇 <a href="./learning-nanomsg-2">nanomsg源码阅读（二）</a> 介绍了nanomsg的实用工具类utils模块，这篇将试图解析下nanomsg最核心的aio（即用线程池模拟带状态机的异步IO）模块，当然这里的IO是广义上的IO，包含了用户自定义事件的输入输出，后面的分析中我们会看到。</p>
<!-- more -->
<h2>定时任务集合：timerset.h timerset.c</h2>
<p>采用有序链表方式实现，新增定时任务时，根据到期timeout时间，排序插入，最近到期置于链表头，通过nn_timerset_timeout函数获取最近到期时间与当前时间的差，作为参数传入nn_poller_wait</p>
<h2>IO多路分离器：poller.h poller.c&nbsp;poller_kqueue.h&nbsp;poller_kqueue.inc poller_epoll.h&nbsp;poller_epoll.inc&nbsp;poller_poll.h&nbsp;poller_poll.inc</h2>
<p>前文提到常用的IO多路分离器，网上对他们各自的对比也有很多，这里不再细述了，值得注意的是nanomsg打开任意的fd都会设置CLOEXEC标志（出于安全方面的考虑）。</p>
<h2>上下文环境：ctx.h ctx.c</h2>
<p>每个nn_socket对应一个nn_ctx，调用关系为:nn_socket–&gt;nn_sock_init–&gt;nn_ctx_init，即程序中创建了多少个nn_socket就创建了多少个nn_ctx。</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_mutex</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">            //互斥量</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_pool</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">pool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">            //线程池外部初始化后，init时赋值</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> events</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">          //本上下文状态机事件队列</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> eventsto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">        //外部状态机事件队列</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    nn_ctx_onleave onleave;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">          //通知函数，在nn_ctx_leave时调用</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">}; </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">//上下文初始化与回收</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_ctx_init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_pool</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">pool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B">                  nn_ctx_onleave</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic"> onleave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_ctx_term</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">//对上下文上锁</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_ctx_enter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">/* 先处理完内部的events，调用onleave函数通知owner，</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> * 再copy一份eventsto队列后，对ctx解锁，之后处理外部上下文队列数据</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_ctx_leave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">//对nn_pool_choose_worker的包装，从线程池中选取一个thread作为工作线程</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_worker</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nn_ctx_choose_worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">//往内部状态机事件队列中添加事件</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_ctx_raise</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm_event</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">event</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">//往外部状态机时间队列中添加事件，仅用在线程间通讯中</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF"> nn_ctx_raiseto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm_event</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">event</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>线程池：pool.h pool.c</h2>
<p>好吧，pool.c上赫然的TODO告诉我们：这个线程池里面目前其实只有一个线程。</p>
<blockquote>
<p>/* TODO: The dummy implementation of a thread pool. As for now there's only&nbsp;one worker thread created. */</p>
</blockquote>
<p>这个线程池需要在外部进行初始化，然后在aio contex初始化时，赋上对它的引用，通过nn_ctx_choose_worker函数从线程池中选取一个thread作为该上下文的工作线程worker。</p>
<h2>工作线程：worker.h worker.c worker_win.h worker_win.inc worker_posix.h worker_posix.inc</h2>
<p>这里我主要查看的是posix的实现：worker_posix.inc，windows的实现没有细看了。</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_mutex</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">              //对下面自定义任务队列tasks操作的锁</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> tasks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">             //本工作线程的待处理自定义任务队列</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue_item</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> stop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">         //worker停止通知任务，收到此任务后，线程将终止</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_efd</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> efd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                 //用于处理自定义任务task事件的通知描述符</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_poller</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> poller</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">           //多路分离器，处理定时timer、IO的fd、任务通知efd</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_poller_hndl</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> efd_hndl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">    //用于标识此事件为自定义任务task</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_timerset</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> timerset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">       //定时任务列表</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_thread</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">           //工作线程</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>工作线程有三类工作要做，由多路分离器poller轮询获取处理（具体处理流程在nn_worker_routine函数里有较为清晰的注释），他们分别为：</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">//定时任务</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_worker_timer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">owner</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_timerset_hndl</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> hndl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">//文件描述符的IO操作</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_worker_fd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> src;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">owner</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_poller_hndl</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> hndl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">//自定义任务</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_worker_task</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> src;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">owner</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue_item</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>值得注意的是：处理工作前，都会对工作处理状态机nn_fsm所属的上下文nn_ctx上锁并处理（调用nn_ctx_enter/nn_ctx_leave）。</p>
<p>即worker中通过nn_poller_wait轮询获取工作，然后每一个工作都有对应的状态机nn_fsm做流程处理。</p>
<h2>状态机：fsm.h fsm.c</h2>
<p>上面看到worker接到工作以后，进入工作区域，按照工作流程来处理，如果这是一个顺序执行的大步骤，便相当于同步流程了。引入状态和状态机以后，将工作进一步切分为几个步骤，通过状态机状态及动作的方式，不仅让流程相对清晰，更通过这样对任务的进一步细分，将很多同步的操作内部转变为异步。</p>
<p>传统的状态机一般由状态state+动作action构成，这里的状态机增加了一个来源src：即动作发起者</p>
<div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c++"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm_event</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">fsm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">          //事件所属状态机</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> src;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                     //事件发起者</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">srcptr;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                //事件发起者附属信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> type;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                    //动作action，因为包含文件的IO，这里取名为type</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_queue_item</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">   //事件会加入到nn_ctx的events队列中</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    nn_fsm_fn fn;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                //状态机处理主函数，大switch所在</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">    nn_fsm_fn shutdown_fn;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">       //状态机关闭处理函数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> state;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                   //状态</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> src;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                     //本状态机的源（动作发起者）</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">srcptr;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">                //来源附属信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">owner</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">        //父指针</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_ctx</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B">ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">          //状态机所属上下文</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">    struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B"> nn_fsm_event</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B"> stopped</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> //状态机停止事件</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">};</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基础的fsm内部有个默认的src：NN_FSM_ACTION，以及与此相对应的两个action：NN_FSM_START/NN_FSM_STOP，而后用户可以在此基础上扩展，只要定义的src和action不冲突即可（默认为负，只要自定义为正即可）。</p>
<h2>定时处理：timer.h timer.c</h2>
<p>使用状态机具体实现</p>
<h2>socket包装：usock.h usock.c usock_posix.h usock_posix.inc usock_win.h usock_win.inc</h2>
<p>使用状态机具体实现</p>
<h2>总结</h2>
<p>aio应该是nanomsg最核心的模块了，中间最复杂的当属作者将将状态机引入到事件驱动的编程中。</p>
<p>martin用了连续两篇博客&nbsp;<a href="http://250bpm.com/blog:24" target="_blank" rel="noopener noreferrer">《The Callback Hell》</a>及<a href="http://250bpm.com/blog:25" target="_blank" rel="noopener noreferrer">《Event-driven architecture, state machines et al.》</a>介绍了传统的callback的恶心，最主要的是不易扩展，而网络层的scalable正式nanomsg追求的目标也是与zeromq最大的区别，用户可以在其核心构建基础上，实现自己的网络拓扑协议。martin在文章里有说过有空要博客详细介绍下nanomsg的状态机机制，可惜到目前为止，他还没有写……。</p>
<p>欢迎大家探讨指正！</p>
]]></content>
    <category term="learning"/>
    <published>2013-11-09T22:18:02.000Z</published>
  </entry>
  <entry>
    <title type="text">RETE算法初窥</title>
    <id>https://abstiger.com/blog/learning-rete.html</id>
    <link href="https://abstiger.com/blog/learning-rete.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p>在规则世界里，RETE算法应该是无人不晓了，许多有名的规则引擎或者专家系统都是基于RETE算法实现的，包括Jess，JRules，Drools，CLIPS等。</p>
]]></summary>
    <content type="html"><![CDATA[<p>在规则世界里，RETE算法应该是无人不晓了，许多有名的规则引擎或者专家系统都是基于RETE算法实现的，包括Jess，JRules，Drools，CLIPS等。</p>
<!-- more -->
<h2>算法简介</h2>
<p>引用下wiki上关于<a href="http://en.wikipedia.org/wiki/Rete_algorithm" title="RETE algorithm" target="_blank" rel="noopener noreferrer">RETE算法</a>的定义：</p>
<blockquote>
<p>RETE（/'ri:ti:/ or /'reiti:/）算法是个高效的可用于实现规则产生式系统（一种计算机程式，一般用于提供某种形式的人工智能，主要由基于行为的一系列规则构成）的模式匹配算法。</p>
</blockquote>
<p>简而言之就是一套规则匹配优化算法。这个算法最早出现在1974年Dr Charles L. Forgy的一篇工作报告中，随后在1979年他的博士论文中完善，然后是1982年在《人工智能》杂志上的一篇<a href="http://www.csl.sri.com/users/mwfong/Technical/RETE%20Match%20Algorithm%20-%20Forgy%20OCR.pdf" title="RETE MATCH" target="_blank" rel="noopener noreferrer">文章</a>。</p>
<h2>原理简介</h2>
<p>现实中，如果要实现一个由若干规则组成的系统？最原始的做法大致应该是（类似krrules，囧）：匹配第一条规则，再匹配下一条规则，直到所有规则匹配完毕。这样的规则匹配时间就应该是与规则数量呈线性关系：即随着规则数目的增多，规则的匹配时间线性增长。而在一些由大量规则构成的专家系统（Expert System）中，这样的规则匹配效率达不到要求，这促使了RETE的诞生。</p>
<h3>名词解释</h3>
<p>有几个名词在描述RETE时会用到，他们大致是这些：</p>
<ol>
<li>facts:指RETE网络中的输入项，数据元祖（data tuples）。</li>
<li>rule:指用于对facts进行模式匹配的条件设置。</li>
<li>action：指满足规则匹配后的动作处理。</li>
<li>production:由一个或多个规则加上一系列动作构成。</li>
<li>WME:当facts被插入引擎，即为它们创立（working memory elements）。</li>
</ol>
<h3>匹配流程</h3>
<figure><figcaption>Drools RETEOO</figcaption></figure>
<p>参考上图，一个完整的RETE规则匹配流程大致是这样的：</p>
<ol>
<li>一个或多个事实facts被assert进RETE规则网络，</li>
<li>网络根据配置的规则rules进行模式匹配，并为facts创建WMEs，</li>
<li>对于触发规则的facts创建activitions并放入agenda中，</li>
<li>agenda根据触发规则优先级salience确立触发次序，</li>
<li>最后执行action。</li>
</ol>
<h3>节点分类</h3>
<p>最初Dr Charles L. Forgy提出的RETE网络是由四种节点构成，分别为：</p>
<ul>
<li>root node（输入起始节点）</li>
<li>one-input node（单fact的条件匹配）</li>
<li>two-input node（多facts的联合join）</li>
<li>terminal node（走到此节点，则规则匹配）</li>
</ul>
<p>人们在算法实现时又常常将one-input node再细分为：</p>
<ul>
<li>Type Node：定位事实属性，确定fact的class，在krrules实现时将此步称为确定所属数据源，这为后续的节点定义和操作做好了铺垫；</li>
<li>Alpha Node：对fact的属性进行匹配判断，比如对一个person的fact，判断其age是否大于18，gender是否为male等；</li>
<li>Beta Node：则相对更为复杂一些，需要实现了两个fact的关联与匹配（比如一个person是否出现在一次party人员名单中）。
具体的节点和功能作用，此处不再赘述了，想要更详细的了解rete算法的同学，除了阅读上面的原作者论文，还可参考这篇文章：<a href="http://reports-archive.adm.cs.cmu.edu/anon/1995/CMU-CS-95-113.pdf" target="_blank" rel="noopener noreferrer">《Production Matching For Large Learning Systems》</a>，有好几十页的篇幅详细的介绍了RETE算法。</li>
</ul>
<h2>算法总结</h2>
<p>以上，可以发现RETE的优点在于：</p>
<ol>
<li>通过节点共享（node sharing）减少了规则中重复模式（pattern）的计算；</li>
<li>存储了部分匹配fact联合join匹配的结果，这样当facts少量变化时，免去未变化的计算量。</li>
</ol>
<p>了解优点后，我们也很容易总结发现RETE相对于传统的线性匹配的优势点或优化场景在于：<br>
<strong>大量规则（规则间具有某些重复pattern的情况），少量变化（规则判定的facts不是每次都重新assert）</strong><br>
在这样的场景下RETE规则匹配算法会得到更好的效果，这对规则的设计与开发者是有些指导意义的。</p>
<h2>应用案例</h2>
<p>RETE在诞生以后，被广泛的用于专家系统和规则引擎的构建中，其中著名的有：</p>
<ul>
<li>专家系统<a href="http://clipsrules.sourceforge.net/" title="CLIPS" target="_blank" rel="noopener noreferrer">CLIPS</a>：源于1984年NASA的人工智能项目，现已开源，由C编写，简单看过源码，逻辑组织还是比较清晰的，后面详细阅读过源码后，有机会再专门介绍下。</li>
<li>规则引擎<a href="http://www.jboss.org/drools/" title="drools" target="_blank" rel="noopener noreferrer">Drools</a>：现在是jboss的开源项目，现已被广泛应用到各商业产品的开发中，drools文档中有关于RETE的实现RETEOO通俗易懂的介绍，可参考：<a href="http://docs.jboss.org/drools/release/6.0.0.Beta5/drools-expert-docs/html/ch01.html#d0e515" target="_blank" rel="noopener noreferrer">http://docs.jboss.org/drools/release/6.0.0.Beta5/drools-expert-docs/html/ch01.html#d0e515</a></li>
</ul>
]]></content>
    <category term="learning"/>
    <published>2013-07-28T16:58:24.000Z</published>
  </entry>
  <entry>
    <title type="text">SQLAlchemy初见</title>
    <id>https://abstiger.com/blog/learning-sqlalchemy.html</id>
    <link href="https://abstiger.com/blog/learning-sqlalchemy.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p><a href="http://www.sqlalchemy.org/" title="SQLAlchemy" target="_blank" rel="noopener noreferrer">SQLAlchemy</a>&nbsp;读['ælkəmi]，提供了一整套Python操作数据库databases的工具集，它的构成与框架如下：</p>
<figure><figcaption>sqla_arch_small</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<p><a href="http://www.sqlalchemy.org/" title="SQLAlchemy" target="_blank" rel="noopener noreferrer">SQLAlchemy</a>&nbsp;读['ælkəmi]，提供了一整套Python操作数据库databases的工具集，它的构成与框架如下：</p>
<figure><figcaption>sqla_arch_small</figcaption></figure>
<!-- more -->
<h2>组件关系</h2>
<p>下面就从下而上描述下各个组件及他们之间的关系：</p>
<p><a href="http://www.python.org/dev/peps/pep-0249/" title="Python Database API Specification" target="_blank" rel="noopener noreferrer">DBAPI</a>定义了Python访问数据库的接口规范，不同的数据库都会根据此规范提供对应Python驱动接口，例如：Python-MYSQLdb</p>
<p><a href="http://docs.sqlalchemy.org/en/rel_0_8/dialects/index.html" title="dialect" target="_blank" rel="noopener noreferrer">Dialect</a>提供了SQLAlchemy与不同数据库驱动接口通信的“方言”（官方数据库包括：'drizzle','firebird','informix','mssql','mysql','postgresql','sqlite','oracle','sybase'，当然还有些非主流的数据库，比如MaxDB与access等，依然可以通过external project的方式提供支持），封装了不同数据库独有的特性，例如：mysql会自动关闭不活跃连接（默认为8个小时），通过pool_recycle选项（设置小于8小时，比如2小时：7200）便可控制重连数据库的频率，著名的mysql gone away问题便可以fix了~</p>
<p><a href="http://docs.sqlalchemy.org/en/rel_0_8/core/pooling.html" title="connection pooling" target="_blank" rel="noopener noreferrer">Connection pooling</a>提供了连接池功能，内存中缓存了一些连接句柄，能缓解客户端频繁与数据库建立连接的压力。</p>
<p>而dialect与connection pooling 功能都被整合进<a href="http://docs.sqlalchemy.org/en/rel_0_8/core/engines.html" title="engine" target="_blank" rel="noopener noreferrer">Engine</a>模块了，在创建数据库连接引擎时可指定对应的数据库及数据库特性（dialect）和是否需要连接池及连接池大小等（pool）。engine与dialect、pool及DBAPI的关系参考下图：</p>
<figure><figcaption>sqla_engine_arch</figcaption></figure>
<p><a href="http://docs.sqlalchemy.org/en/rel_0_8/core/schema.html" title="schema" target="_blank" rel="noopener noreferrer">Schema</a>则为class定义到数据库的ddl语句提供了媒介，通过schema包里的Table、Column、ForeignKey及Sequence组件，便可轻松描述一个database。</p>
<p><a href="http://docs.sqlalchemy.org/en/rel_0_8/core/types.html" title="Types" target="_blank" rel="noopener noreferrer">Types</a>为不同数据库的数据类型提供更普遍一些的抽象，基本只应用在提供对表Table的列Column定义上，常见的类型有：Integer，String，Sate，DateTime。</p>
<p>剩下两个最主要的大块了：<a href="http://docs.sqlalchemy.org/en/rel_0_8/core/tutorial.html" title="core tutorial" target="_blank" rel="noopener noreferrer">SQL Expression Language</a>与<a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/index.html" title="orm " target="_blank" rel="noopener noreferrer">Object Relational Mapper</a>（ORM）了，而这两块也是SQLAlchemy对外暴露的两种访问操作方式，当然他们之间亦存在上下级关系，ORM是对SQL Expression Language更高一层的封装。</p>
<p>文中如此描述二者的区别与不同：</p>
<blockquote>
<p>In contrast to the ORM’s domain-centric mode of usage, the expression language provides a schema-centric usage paradigm.</p>
</blockquote>
<p><a href="http://docs.sqlalchemy.org/en/rel_0_8/core/tutorial.html" title="core tutorial" target="_blank" rel="noopener noreferrer">SQL Expression Language</a>是对数据库操作尽可能简单、直观（as closely as possible）的Python封装，最大限度的统一了不同数据库的共同点，实现了数据库操作的无关性。</p>
<p><a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/index.html" title="orm " target="_blank" rel="noopener noreferrer">Object Relational Mapper</a>则是暴露在整个SQLAlchemy最上端的接口了，</p>
<p>而<a href="http://en.wikipedia.org/wiki/Object-relational_mapping" title="orm" target="_blank" rel="noopener noreferrer">ORM</a>显然不是SQLAlchemy的专利，而是一种设计抽象模式，引用下中文维基里对ORM的描述：</p>
<blockquote>
<p>对象关系映射（Object Relational Mapping，简称ORM，或O/RM，或O/R mapping），是一种程序设计技术，用于实现面向对象编程语言里不同类型系统的数据之间的转换。从效果上说，它其实是创建了一个可在编程语言里使用的“虚拟对象数据库”。面向对象是从软件工程基本原则（如耦合、聚合、封装）的基础上发展起来的，而关系数据库则是从数学理论发展而来的，两套理论存在显著的区别。为了解决这个不匹配的现象，对象关系映射技术应运而生。</p>
</blockquote>
<p>很多语言都有各自有名的ORM产品，比如.NET里的ADO、java里的hibernate，SQLAlchemy则是Python里目前看来比较有名的ORM产品了！</p>
<p>而C语言的世界里也有一朵奇葩：<a href="https://github.com/abstiger/rapodbc" title="rapodbc" target="_blank" rel="noopener noreferrer">rapodbc</a>（object得换成struct），O(∩_∩)O哈哈~，开玩笑啦~</p>
<h2>个人理解</h2>
<p>从开发角度上考虑，可以发现<a href="http://docs.sqlalchemy.org/en/rel_0_8/core/tutorial.html" title="core tutorial" target="_blank" rel="noopener noreferrer">SQL Expression Language</a>更偏向于传统的开发模式，</p>
<ul>
<li>优点在：类SQL方式可以想到哪儿便写到那儿、想怎么写怎么写（可以写很复杂的数据库操作语句）</li>
<li>缺点在：代码比较混乱、难维护，表结构变更带来的程序影响难以评估与修改</li>
</ul>
<p>而<a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/index.html" title="orm " target="_blank" rel="noopener noreferrer">Object Relational Mapper</a>则需要在程序开发前对数据库模型及操作关系在脑中有一个轮廓，</p>
<ul>
<li>优点在：数据库模型和关系清晰，具有比较好的抽象和使用</li>
<li>缺点在：有些特殊恶心的操作可能还很难转换为模型，对数据库建模有较高要求</li>
</ul>
<p>刚接触SQLAlchemy，这篇文章基本是阅读SQLAlchemy的<a href="http://docs.sqlalchemy.org/en/rel_0_8/" title="sqlalchemy docs" target="_blank" rel="noopener noreferrer">documents</a>后的笔记和粗线条概括，很多的概念和术语还理解的不够深刻或者有问题，错误之处，还请大家指正！</p>
]]></content>
    <category term="learning"/>
    <published>2012-12-28T19:28:51.000Z</published>
  </entry>
  <entry>
    <title type="text">SVM求解幼儿园问题</title>
    <id>https://abstiger.com/blog/playing-with-svm.html</id>
    <link href="https://abstiger.com/blog/playing-with-svm.html"/>
    <updated>2025-11-15T10:21:25.000Z</updated>
    <summary type="html"><![CDATA[<p>这是前段时间在微博上闹的还蛮火热的这样一道幼儿园问题：</p>
<figure><figcaption>kindergarden-problem</figcaption></figure>
<p>很多ML大牛都发表了他们对这一题的看法，基本认为这是一个线性回归（linear regression）的问题，有些大牛还写了些小程序用以证明，结果很漂亮也很让人兴奋~<a href="http://yongsun.me/2012/06/%e7%ba%bf%e6%80%a7%e5%9b%9e%e5%bd%92%e6%b1%82%e8%a7%a3%e5%b9%bc%e5%84%bf%e5%9b%ad%e6%95%b0%e5%ad%a6%e9%a2%98/" title="线性回归求解幼儿园数学题" target="_blank" rel="noopener noreferrer">参考博客</a>。</p>
]]></summary>
    <content type="html"><![CDATA[<p>这是前段时间在微博上闹的还蛮火热的这样一道幼儿园问题：</p>
<figure><figcaption>kindergarden-problem</figcaption></figure>
<p>很多ML大牛都发表了他们对这一题的看法，基本认为这是一个线性回归（linear regression）的问题，有些大牛还写了些小程序用以证明，结果很漂亮也很让人兴奋~<a href="http://yongsun.me/2012/06/%e7%ba%bf%e6%80%a7%e5%9b%9e%e5%bd%92%e6%b1%82%e8%a7%a3%e5%b9%bc%e5%84%bf%e5%9b%ad%e6%95%b0%e5%ad%a6%e9%a2%98/" title="线性回归求解幼儿园数学题" target="_blank" rel="noopener noreferrer">参考博客</a>。</p>
<!-- more -->
<p>有粗略看了下@TreapDB大牛用python写的BP神经网络求解程序，结果也很给力！也了解到一些关于支持向量机与神经网络的对比，在样本需求和训练时间上SVM似乎还是要占优的， 于是我也忍不住想尝试下用SVM来求解，当然是借助工具了，具体用的是<a href="http://svmlight.joachims.org/" title="SVM-light" target="_blank" rel="noopener noreferrer">SVM-light</a>，写这篇博文的目的也就是为了记录下我艰辛的求解过程，O(∩_∩)O哈哈~：</p>
<h2>思考过程</h2>
<p>刚好这段时间尝试看了些机器学习Machine Learning的东东，具体是<a href="http://en.wikipedia.org/wiki/Support_vector_machine" title="SVM" target="_blank" rel="noopener noreferrer">支持向量机SVM</a>这块的内容，因为数学已经忘的差不多了，而且自己的高等代数当时就学的很不好，所以基本上遇到公式、推导什么的都直接跳过了……</p>
<p>关于svm的理论介绍我就不献丑了，在上面wiki链接里有一个External links的模块，里面有很多svm相关的学习指南和工具，其中我觉得Fletcher, Tristan写的这篇<a href="http://www.tristanfletcher.co.uk/SVM%20Explained.pdf" title="SVM Explained.pdf" target="_blank" rel="noopener noreferrer">SVMExplained</a>还是给像我这样的初学者很多直观的感受。当然这里面还给出了很多svm相关的工具箱链接，包括SVM-light、Libsvm、Shogun……</p>
<h3>Step 1、Solve it as a numeric multiclass problem：</h3>
<p>说来惭愧，其实一看到这题的时候，我并不知道这是个“数圈圈”的问题，而是直观的理解为一个四维空间里的多值分类问题：根据测试数据的坐标点分布多值分类：0-9，确定w,b以判断待检测坐标点的所属分类。</p>
<p>于是我的训练数据train1.dat为：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:9</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8809</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2172</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:6</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #6666</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #1111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2222</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7662</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:3</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9313</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #0000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:5</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #5555</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:3</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8193</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:6</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8096</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:8</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #4398</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:5</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9475</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:8</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9038</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:8</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #3148</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试数据我加上了训练数据的内容和一条待预测的内容test1.dat：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:9</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8809</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2172</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:6</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #6666</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #1111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2222</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7662</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:3</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9313</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #0000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:5</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #5555</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:3</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8193</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:6</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8096</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:8</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #4398</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:5</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9475</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:8</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9038</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:8</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #3148</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:9</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2889</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注释</strong>：因为是多值分类，所以我用的是SVM-multiclass，又因为SVM-multiclass的“target”要求必须大于等于1，于是我便将所有的target值加了1。</p>
<p>执行命令：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">svm_multiclass_learn</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -t</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> train1.dat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1.model</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">svm_multiclass_classify</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test1.dat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1.model</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> predict1.dat</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后我依次尝试了四个核，得到的预测结果依次为：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"># -t 0（线性核）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">Zero/one-error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> set:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 52.94%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (8 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">correct,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> incorrect,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> total</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#-t 1（多项式核）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">Zero/one-error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> set:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 11.76%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (15 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">correct,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> incorrect,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> total</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#-t 2（径向基核）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">Zero/one-error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> set:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5.88%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (16 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">correct,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> incorrect,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> total</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#-t 3（sigmoid核）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">Zero/one-error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> set:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 94.12%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (1 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">correct,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> incorrect,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> total</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果发现采用径向基核对训练用的test数据能完全分类，可是对待测试的2889却分类错误了，期待是6，却归到了7。</p>
<p>虽然这是一个完全错误的方向，但是却给了我两方面启示：</p>
<ol>
<li>机器学习想要做到完全智能并不容易，数据的分布及其含义的理解，还是需要人工分析或者进一步的数据挖掘；</li>
<li>虽然无法通过绘制四维空间图观察到数据坐标点的直观分布，但是通过测试结果，应该可以判定训练数据的点是线性不可分的。
而由非线性到线性空间转换的RBF径向基核函数好给力，怪不得LIBsvm用它做默认核函数了。</li>
</ol>
<h3>Step 2、Solve it as counting “O” multiclass problem：</h3>
<p>后来按照微博里说的将此问题转换为让机器去学习数字中带圈的个数后，便参考大牛的做法：“将0-9每个数字出现的次数，作为feature vector”，继续采用多值分类的方式：</p>
<p>于是我的训练数据train.dat为：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8809</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2172</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #6666</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #1111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2222</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7662</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9313</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:4</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #0000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #5555</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8193</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8096</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #4398</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9475</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9038</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #3148</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试数据test.dat为：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8809</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2172</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #6666</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #1111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2222</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7662</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9313</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:4</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #0000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #5555</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8193</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8096</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #4398</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9475</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9038</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #3148</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2889</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行命令：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">svm_multiclass_learn</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1000</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -t</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> train.dat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> model</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">svm_multiclass_classify</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test.dat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> model</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> predict.dat</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后我依次尝试了四个核：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#-t 0（线性核）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">Zero/one-error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> set:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 11.76%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (15 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">correct,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> incorrect,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> total</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#-t 1（多项式核）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">Zero/one-error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> set:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5.88%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (16 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">correct,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> incorrect,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> total</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#-t 2（径向基核）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">Zero/one-error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> set:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5.88%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (16 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">correct,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> incorrect,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> total</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#-t 3（sigmoid核）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">Zero/one-error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> set:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 64.71%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> (6 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">correct,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 11</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> incorrect,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> total</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果发现用多项式核和径向基核时，训练数据都能准确归类，而2889也都被错误的归到7类中了，而期待应该是6（加1的关系）。</p>
<p>这与@TreapDB大牛开始用BPNN把此问题当成分类问题得出的解是一样的……</p>
<h3>Step 3、Solve it as Linear regression problem：</h3>
<p>后来又听说这好像是个线性回归的问题……，便尝试用SVM-light的Regression来做（通过-z r参数指定）：</p>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>-z {c,r,p}&nbsp; - select between classification (c), regression (r), and preference ranking (p) (see [Joachims, 2002c]) (default classification)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><p>于是便将训练数据train.regression.dat改为：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8809</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2172</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #6666</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #1111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2222</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7662</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9313</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:4</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #0000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #5555</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8193</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8096</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #4398</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9475</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9038</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #3148</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试数据test.regression.dat又增加了两个2467，1893：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8809</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2172</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #6666</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #1111</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2222</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #7662</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9313</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:4</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #0000</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #5555</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8193</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #8096</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #4398</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9475</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #9038</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #3148</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2889</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #2467</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 2:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 3:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 4:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 5:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 6:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 7:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 8:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 9:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 10:0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic"> #1893</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注释</strong>： 因为是回归，所以我用的是SVM-light，而回归的target便没有了必须大于等于1限制，所以便将target值都改回正确了。</p>
<p>执行命令：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">svm_learn</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 2.0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -t</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -z</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> r</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> train.regression.dat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> regression.model</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">svm_classify</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test.regression.dat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> regression.model</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> predict.regression.dat</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>得到预测结果predict.regression.dat为：</p>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0.041134824</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">5.9</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0.10000005</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3.9</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">-0.017730418</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0.10000004</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2.0294327</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1.1000001</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">0.10000004</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2.9852837</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4.9139628</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">3.0573582</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4.0147164</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2.1000001</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">4.9</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">1.1220745</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">2.9852837</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与上面test.regression.dat第一列的target值对比便可发现，四舍五入后结果是完全吻合的。给力！</p>
<h2>问题总结</h2>
<p>最大的感受就是：机器学习或者说数据挖掘的首要事情是给问题定性，确定数据的分布情况和求解方式！</p>
<p>由于本人的机器学习及SVM理论知识还有对SVM-light工具还都不是很了解，整个实验的过程基本靠蒙和猜测，错误或者不合理之处，还请大家指正！</p>
]]></content>
    <category term="playing"/>
    <published>2012-07-06T19:59:19.000Z</published>
  </entry>
</feed>